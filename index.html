<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebPlayer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.7/hls.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap');

:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a26;
  --surface3: #222233;
  --border: #2a2a3f;
  --accent: #6c63ff;
  --accent2: #ff6b9d;
  --accent-glow: rgba(108,99,255,0.25);
  --text: #e8e8f0;
  --text2: #9090aa;
  --text3: #5a5a75;
  --success: #4ade80;
  --danger: #f87171;
  --sidebar-w: 320px;
  --header-h: 56px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  overflow: hidden;
}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

/* â”€â”€ Layout â”€â”€ */
#app {
  display: grid;
  grid-template-rows: var(--header-h) 1fr;
  grid-template-columns: var(--sidebar-w) 1fr;
  grid-template-areas: "header header" "sidebar main";
  height: 100vh;
}

/* â”€â”€ Header â”€â”€ */
#header {
  grid-area: header;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  z-index: 100;
  position: relative;
}

#header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, var(--accent), var(--accent2), transparent);
  opacity: 0.5;
}

.logo {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 18px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.5px;
  white-space: nowrap;
}

.logo-icon {
  width: 30px; height: 30px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 0 16px var(--accent-glow);
}

.logo-icon svg { width: 16px; height: 16px; fill: white; }

/* URL input bar */
#url-bar {
  flex: 1;
  display: flex;
  gap: 8px;
  max-width: 600px;
}

#url-input {
  flex: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 7px 14px;
  color: var(--text);
  font-size: 13px;
  font-family: inherit;
  transition: border-color .2s, box-shadow .2s;
  outline: none;
}
#url-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
#url-input::placeholder { color: var(--text3); }

.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 7px 14px;
  border: none; border-radius: 8px;
  cursor: pointer;
  font-size: 12px; font-weight: 500;
  font-family: inherit;
  transition: all .18s;
  white-space: nowrap;
}
.btn-primary {
  background: var(--accent);
  color: white;
  box-shadow: 0 2px 12px rgba(108,99,255,.3);
}
.btn-primary:hover { background: #7c73ff; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(108,99,255,.4); }
.btn-secondary {
  background: var(--surface3);
  color: var(--text2);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--border); color: var(--text); }
.btn-danger { background: rgba(248,113,113,.15); color: var(--danger); border: 1px solid rgba(248,113,113,.2); }
.btn-danger:hover { background: rgba(248,113,113,.25); }
.btn-sm { padding: 4px 10px; font-size: 11px; }
.btn-icon { padding: 7px; }

.header-right { display: flex; align-items: center; gap: 8px; margin-left: auto; }

/* Lang toggle */
.lang-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 5px 10px;
  color: var(--text2);
  cursor: pointer;
  font-size: 12px;
  font-family: inherit;
  transition: all .18s;
}
.lang-btn:hover { border-color: var(--accent); color: var(--accent); }

/* â”€â”€ Sidebar â”€â”€ */
#sidebar {
  grid-area: sidebar;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.sidebar-tab {
  flex: 1;
  padding: 10px 8px;
  text-align: center;
  font-size: 12px;
  font-weight: 500;
  color: var(--text3);
  cursor: pointer;
  transition: all .18s;
  border-bottom: 2px solid transparent;
}
.sidebar-tab:hover { color: var(--text2); }
.sidebar-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.sidebar-pane { display: none; flex-direction: column; flex: 1; overflow: hidden; }
.sidebar-pane.active { display: flex; }

.sidebar-toolbar {
  display: flex; gap: 6px; padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  flex-wrap: wrap;
}

.channel-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px;
}

.channel-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: background .15s;
  border: 1px solid transparent;
  position: relative;
  user-select: none;
}
.channel-item:hover { background: var(--surface2); }
.channel-item.playing {
  background: rgba(108,99,255,.12);
  border-color: rgba(108,99,255,.25);
}
.channel-item.playing::before {
  content: '';
  position: absolute;
  left: 0; top: 50%; transform: translateY(-50%);
  width: 3px; height: 60%;
  background: var(--accent);
  border-radius: 2px;
}

.channel-logo {
  width: 36px; height: 36px;
  border-radius: 6px;
  background: var(--surface3);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  overflow: hidden;
  font-size: 14px;
  font-weight: 700;
  color: var(--accent);
  font-family: 'Syne', sans-serif;
}
.channel-logo img { width: 100%; height: 100%; object-fit: contain; }

.channel-info { flex: 1; min-width: 0; }
.channel-name {
  font-size: 13px; font-weight: 500;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  color: var(--text);
}
.channel-group { font-size: 11px; color: var(--text3); margin-top: 2px; }

.channel-actions {
  display: none;
  gap: 4px;
  flex-shrink: 0;
}
.channel-item:hover .channel-actions { display: flex; }

.icon-btn {
  width: 26px; height: 26px;
  border: none; background: none;
  border-radius: 5px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: var(--text3);
  transition: all .15s;
}
.icon-btn:hover { background: var(--surface3); color: var(--text); }
.icon-btn.del:hover { color: var(--danger); background: rgba(248,113,113,.1); }

/* Playing indicator animation */
.playing-bars {
  display: flex; align-items: flex-end; gap: 2px;
  height: 16px;
}
.playing-bars span {
  width: 3px; background: var(--accent); border-radius: 1px;
  animation: bars 0.8s ease-in-out infinite;
}
.playing-bars span:nth-child(2) { animation-delay: .15s; }
.playing-bars span:nth-child(3) { animation-delay: .3s; }
@keyframes bars {
  0%, 100% { height: 4px; }
  50% { height: 14px; }
}

.empty-state {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 12px; padding: 40px 20px;
  color: var(--text3); text-align: center;
}
.empty-state svg { opacity: .3; }
.empty-state p { font-size: 13px; line-height: 1.6; }

/* Group label */
.group-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text3);
  padding: 8px 10px 4px;
}

/* Playlist header */
.playlist-header {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px;
  background: var(--surface2);
  border-radius: 8px;
  margin: 4px 6px 2px;
  cursor: pointer;
}
.playlist-header-name {
  flex: 1; font-size: 12px; font-weight: 600;
  color: var(--text2); white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}
.playlist-count {
  font-size: 10px; color: var(--text3);
  background: var(--surface3);
  padding: 1px 6px; border-radius: 10px;
}

/* â”€â”€ Main Content â”€â”€ */
#main {
  grid-area: main;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg);
}

/* â”€â”€ Player â”€â”€ */
#player-wrap {
  flex-shrink: 0;
  position: relative;
  background: #000;
}

/* 16:9 video wrapper */
.video-container {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  max-height: calc(100vh - var(--header-h) - 120px);
  background: #000;
  display: flex; align-items: center; justify-content: center;
}

#video {
  width: 100%;
  height: 100%;
  display: block;
  outline: none;
}

/* Custom overlay controls â€” shown on hover */
.video-overlay {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  justify-content: flex-end;
  opacity: 0;
  transition: opacity .3s;
  background: linear-gradient(transparent 40%, rgba(0,0,0,.8));
}
.video-container:hover .video-overlay,
.video-container.paused .video-overlay { opacity: 1; }

.overlay-title {
  font-size: 14px; font-weight: 600;
  padding: 0 16px 4px;
  color: white;
  text-shadow: 0 1px 4px rgba(0,0,0,.8);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.overlay-controls {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 16px 14px;
}

.ctl-btn {
  width: 34px; height: 34px;
  border: none; background: rgba(255,255,255,.15);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  color: white; font-size: 14px;
  transition: background .15s;
  backdrop-filter: blur(4px);
}
.ctl-btn:hover { background: rgba(255,255,255,.3); }
.ctl-btn.big { width: 44px; height: 44px; font-size: 18px; }

.progress-bar {
  flex: 1;
  height: 4px;
  background: rgba(255,255,255,.2);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width .1s;
  pointer-events: none;
}

.vol-wrap { display: flex; align-items: center; gap: 6px; }
input[type=range] {
  -webkit-appearance: none;
  width: 70px; height: 3px;
  background: rgba(255,255,255,.3);
  border-radius: 2px; outline: none; cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px; height: 12px;
  background: white; border-radius: 50%;
}

.time-label { font-size: 11px; color: rgba(255,255,255,.8); white-space: nowrap; }

/* Player status bar below video */
#status-bar {
  padding: 8px 16px;
  background: var(--surface);
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  flex-shrink: 0;
}

.status-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
  transition: background .3s;
}
.status-dot.live { background: var(--success); box-shadow: 0 0 6px rgba(74,222,128,.5); animation: pulse 2s infinite; }
.status-dot.error { background: var(--danger); }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

.status-text { font-size: 12px; color: var(--text2); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.status-url { font-size: 11px; color: var(--text3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }

/* â”€â”€ Info panel below player â”€â”€ */
#info-panel {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

/* â”€â”€ Modal â”€â”€ */
.modal-backdrop {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity .25s;
}
.modal-backdrop.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  width: min(520px, 95vw);
  max-height: 90vh;
  overflow-y: auto;
  transform: scale(.95) translateY(10px);
  transition: transform .25s;
  box-shadow: 0 24px 80px rgba(0,0,0,.6);
}
.modal-backdrop.open .modal { transform: scale(1) translateY(0); }

.modal-title {
  font-family: 'Syne', sans-serif;
  font-weight: 700; font-size: 18px;
  margin-bottom: 20px;
  display: flex; align-items: center; gap: 10px;
}
.modal-title span { font-size: 20px; }

.form-group { margin-bottom: 14px; }
.form-label { font-size: 12px; color: var(--text2); margin-bottom: 6px; display: block; font-weight: 500; }
.form-input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 9px 12px;
  color: var(--text);
  font-size: 13px;
  font-family: inherit;
  outline: none;
  transition: border-color .2s, box-shadow .2s;
}
.form-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
.form-input::placeholder { color: var(--text3); }
textarea.form-input { resize: vertical; min-height: 120px; font-family: 'Courier New', monospace; font-size: 12px; }

.form-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }

/* Drag zone */
.drop-zone {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 30px 20px;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
  color: var(--text3);
}
.drop-zone:hover, .drop-zone.dragover {
  border-color: var(--accent);
  background: rgba(108,99,255,.06);
  color: var(--accent);
}
.drop-zone svg { margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }
.drop-zone p { font-size: 13px; }
.drop-zone small { font-size: 11px; margin-top: 4px; display: block; }

/* Notification toast */
#toast-container {
  position: fixed; bottom: 20px; right: 20px;
  z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 13px;
  display: flex; align-items: center; gap: 8px;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
  animation: slideIn .3s ease;
  min-width: 220px;
  max-width: 320px;
}
.toast.success { border-left: 3px solid var(--success); }
.toast.error { border-left: 3px solid var(--danger); }
.toast.info { border-left: 3px solid var(--accent); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: none; opacity: 1; } }

/* Search */
.search-wrap {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.search-input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 10px;
  color: var(--text);
  font-size: 12px;
  outline: none;
  font-family: inherit;
}
.search-input:focus { border-color: var(--accent); }
.search-input::placeholder { color: var(--text3); }

/* Tags / badges */
.badge {
  display: inline-block;
  padding: 1px 7px; border-radius: 10px;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.badge-hls { background: rgba(108,99,255,.2); color: var(--accent); }
.badge-mp4 { background: rgba(74,222,128,.15); color: var(--success); }
.badge-rtmp { background: rgba(255,107,157,.15); color: var(--accent2); }

/* â”€â”€ Responsive sidebar toggle â”€â”€ */
#sidebar-toggle {
  display: none;
}

/* â”€â”€ No playing placeholder â”€â”€ */
.no-video-placeholder {
  width: 100%;
  aspect-ratio: 16/9;
  max-height: calc(100vh - var(--header-h) - 120px);
  background: linear-gradient(135deg, #0d0d18 0%, #12121f 50%, #0a0a14 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 16px; color: var(--text3);
  position: relative;
  overflow: hidden;
}
.no-video-placeholder::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at center, rgba(108,99,255,.06) 0%, transparent 70%);
}
.no-video-placeholder .big-icon { font-size: 56px; filter: grayscale(1); opacity: .4; }
.no-video-placeholder h3 { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; color: var(--text2); }
.no-video-placeholder p { font-size: 13px; }

/* spinner */
.spinner {
  width: 28px; height: 28px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-overlay {
  position: absolute; inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center; justify-content: center;
  z-index: 10;
}
.loading-overlay.active { display: flex; }

/* â”€â”€ Sidebar resize handle (visual) â”€â”€ */
#sidebar { position: relative; }

@media (max-width: 768px) {
  :root { --sidebar-w: 0px; }
  #app { grid-template-columns: 0 1fr; }
  #sidebar { position: fixed; left: -320px; top: 0; height: 100vh; width: 320px; z-index: 200; transition: left .3s; }
  #sidebar.open { left: 0; --sidebar-w: 320px; }
  #sidebar-toggle { display: flex; }
}
</style>
</head>
<body>

<div id="app">
  <!-- Header -->
  <header id="header">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </div>
    <span class="logo">WebPlayer</span>

    <div id="url-bar">
      <input id="url-input" type="url" placeholder="https://example.com/video.m3u8 or .mp4 ..." autocomplete="off" spellcheck="false">
      <button class="btn btn-primary" onclick="playFromURLBar()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        <span data-i18n="play">Play</span>
      </button>
    </div>

    <div class="header-right">
      <button class="btn btn-secondary" onclick="openImportModal()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        <span data-i18n="importM3U">Import M3U</span>
      </button>
      <button class="lang-btn" onclick="toggleLang()" id="lang-btn">EN</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="sidebar-tabs">
      <div class="sidebar-tab active" data-tab="playlists" onclick="switchTab('playlists')" data-i18n="playlists">Playlists</div>
      <div class="sidebar-tab" data-tab="history" onclick="switchTab('history')" data-i18n="history">History</div>
    </div>

    <!-- Playlists pane -->
    <div class="sidebar-pane active" id="pane-playlists">
      <div class="sidebar-toolbar">
        <button class="btn btn-secondary btn-sm" onclick="openAddChannelModal()">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"/></svg>
          <span data-i18n="addChannel">Add</span>
        </button>
        <button class="btn btn-secondary btn-sm" onclick="openImportModal()">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          M3U
        </button>
      </div>
      <div class="search-wrap">
        <input class="search-input" id="channel-search" placeholder="Search..." oninput="renderPlaylists()" data-i18n-placeholder="search">
      </div>
      <div class="channel-list" id="playlist-channels"></div>
    </div>

    <!-- History pane -->
    <div class="sidebar-pane" id="pane-history">
      <div class="sidebar-toolbar">
        <button class="btn btn-danger btn-sm" onclick="clearHistory()">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6M10 11v6M14 11v6M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
          <span data-i18n="clearHistory">Clear</span>
        </button>
      </div>
      <div class="channel-list" id="history-list"></div>
    </div>
  </aside>

  <!-- Main -->
  <main id="main">
    <!-- Video Player -->
    <div id="player-wrap">
      <!-- Placeholder -->
      <div class="no-video-placeholder" id="no-video">
        <div class="big-icon">ğŸ¬</div>
        <h3 data-i18n="noVideoTitle">Ready to Play</h3>
        <p data-i18n="noVideoSub">Enter a URL above or pick a channel from the list</p>
      </div>

      <!-- Actual player -->
      <div class="video-container" id="video-container" style="display:none;">
        <video id="video" playsinline></video>

        <div class="loading-overlay" id="loading-overlay">
          <div class="spinner"></div>
        </div>

        <div class="video-overlay" id="video-overlay">
          <div class="overlay-title" id="overlay-title"></div>
          <div class="overlay-controls">
            <button class="ctl-btn" onclick="skip(-10)" title="-10s">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6l5 5V7c3.3 0 6 2.7 6 6s-2.7 6-6 6-6-2.7-6-6H4c0 4.4 3.6 8 8 8s8-3.6 8-8-3.6-8-8-8z"/><text x="12" y="16" text-anchor="middle" font-size="6" fill="currentColor">10</text></svg>
            </button>
            <button class="ctl-btn big" id="play-pause-btn" onclick="togglePlayPause()">
              <svg id="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
              <svg id="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <button class="ctl-btn" onclick="skip(10)" title="+10s">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1l5 5-5 5V7c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6h2c0 4.4-3.6 8-8 8s-8-3.6-8-8 3.6-8 8-8z"/><text x="12" y="16" text-anchor="middle" font-size="6" fill="currentColor">10</text></svg>
            </button>

            <div class="progress-bar" id="progress-bar" onclick="seekTo(event)">
              <div class="progress-fill" id="progress-fill" style="width:0%"></div>
            </div>

            <span class="time-label" id="time-label">0:00 / 0:00</span>

            <div class="vol-wrap">
              <button class="ctl-btn" onclick="toggleMute()">
                <svg id="vol-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.8-1-3.3-2.5-4.1v8.2c1.5-.8 2.5-2.3 2.5-4.1zm2.5-.1c0 3-1.8 5.6-4.5 6.9l1.2 1.9C19.5 19.2 22 15.8 22 12s-2.5-7.2-6.3-8.7l-1.2 1.9C17.2 6.5 19 9.1 19 12z"/></svg>
              </button>
              <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="1" oninput="setVolume(this.value)">
            </div>

            <button class="ctl-btn" onclick="toggleFullscreen()" title="Fullscreen">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Status bar -->
    <div id="status-bar">
      <div class="status-dot" id="status-dot"></div>
      <span class="status-text" id="status-text" data-i18n="ready">Ready</span>
      <span class="status-url" id="status-url"></span>
    </div>

    <!-- Info panel -->
    <div id="info-panel">
      <div id="now-playing-info" style="display:none;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;margin-bottom:6px;" id="np-title"></div>
        <div style="font-size:12px;color:var(--text3);word-break:break-all;" id="np-url"></div>
      </div>
    </div>
  </main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Import M3U Modal -->
<div class="modal-backdrop" id="modal-import">
  <div class="modal">
    <div class="modal-title"><span>ğŸ“‹</span><span data-i18n="importM3UTitle">Import M3U Playlist</span></div>

    <div style="display:flex;gap:8px;margin-bottom:16px;" id="import-tabs">
      <button class="btn btn-primary btn-sm" onclick="switchImportTab('file')" id="itab-file" data-i18n="fromFile">From File</button>
      <button class="btn btn-secondary btn-sm" onclick="switchImportTab('text')" id="itab-text" data-i18n="pasteText">Paste Text</button>
      <button class="btn btn-secondary btn-sm" onclick="switchImportTab('url')" id="itab-url" data-i18n="fromURL">From URL</button>
    </div>

    <!-- File -->
    <div id="import-file">
      <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
        <p data-i18n="dropM3U">Drop .m3u / .m3u8 file here or click to browse</p>
        <small data-i18n="m3uHint">Supports standard M3U format with #EXTINF tags</small>
      </div>
      <input type="file" id="file-input" accept=".m3u,.m3u8,.txt" style="display:none" onchange="onFileSelect(event)">
    </div>

    <!-- Text -->
    <div id="import-text" style="display:none;">
      <div class="form-group">
        <label class="form-label" data-i18n="pasteM3ULabel">Paste M3U content</label>
        <textarea class="form-input" id="m3u-text-input" rows="8" placeholder="#EXTM3U&#10;#EXTINF:-1,Channel Name&#10;http://..."></textarea>
      </div>
    </div>

    <!-- URL -->
    <div id="import-url" style="display:none;">
      <div class="form-group">
        <label class="form-label" data-i18n="m3uURL">M3U URL</label>
        <input class="form-input" id="m3u-url-input" type="url" placeholder="http://example.com/playlist.m3u">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" data-i18n="playlistName">Playlist Name</label>
      <input class="form-input" id="playlist-name-input" type="text" placeholder="My Playlist" data-i18n-placeholder="playlistNamePlaceholder">
    </div>

    <div id="import-preview" style="display:none; margin:10px 0; padding:10px 12px; background:var(--surface2); border-radius:8px; font-size:12px; color:var(--text2);">
    </div>

    <div class="form-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-import')" data-i18n="cancel">Cancel</button>
      <button class="btn btn-primary" onclick="doImport()" data-i18n="importBtn">Import</button>
    </div>
  </div>
</div>

<!-- Add Channel Modal -->
<div class="modal-backdrop" id="modal-add-channel">
  <div class="modal">
    <div class="modal-title"><span>â•</span><span data-i18n="addChannelTitle">Add Channel</span></div>
    <div class="form-group">
      <label class="form-label" data-i18n="channelName">Channel Name</label>
      <input class="form-input" id="ch-name" type="text" placeholder="e.g. CCTV 1">
    </div>
    <div class="form-group">
      <label class="form-label">URL *</label>
      <input class="form-input" id="ch-url" type="url" placeholder="http://...">
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="group">Group</label>
      <input class="form-input" id="ch-group" type="text" placeholder="e.g. News, Sports...">
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="logoURL">Logo URL (optional)</label>
      <input class="form-input" id="ch-logo" type="url" placeholder="http://...logo.png">
    </div>
    <div class="form-group">
      <label class="form-label" data-i18n="playlist">Add to Playlist</label>
      <select class="form-input" id="ch-playlist">
        <option value="__new__" data-i18n="newPlaylist">New playlist...</option>
      </select>
    </div>
    <div id="ch-new-playlist-wrap" class="form-group">
      <input class="form-input" id="ch-new-playlist" type="text" placeholder="Playlist name" data-i18n-placeholder="playlistNamePlaceholder">
    </div>
    <div class="form-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-add-channel')" data-i18n="cancel">Cancel</button>
      <button class="btn btn-primary" onclick="doAddChannel()" data-i18n="add">Add</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  i18n
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANGS = {
  zh: {
    play: 'æ’­æ”¾', importM3U: 'å¯¼å…¥ M3U', playlists: 'æ’­æ”¾åˆ—è¡¨', history: 'å†å²',
    addChannel: 'æ·»åŠ é¢‘é“', clearHistory: 'æ¸…ç©ºå†å²', ready: 'å°±ç»ª',
    noVideoTitle: 'å‡†å¤‡å°±ç»ª', noVideoSub: 'åœ¨ä¸Šæ–¹è¾“å…¥åœ°å€ï¼Œæˆ–ä»å·¦ä¾§é€‰æ‹©é¢‘é“',
    importM3UTitle: 'å¯¼å…¥ M3U æ’­æ”¾åˆ—è¡¨', fromFile: 'ä»æ–‡ä»¶', pasteText: 'ç²˜è´´æ–‡æœ¬', fromURL: 'ä»é“¾æ¥',
    dropM3U: 'æ‹–å…¥ .m3u / .m3u8 æ–‡ä»¶ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©', m3uHint: 'æ”¯æŒæ ‡å‡† M3U æ ¼å¼ (#EXTINF)',
    pasteM3ULabel: 'ç²˜è´´ M3U å†…å®¹', m3uURL: 'M3U é“¾æ¥', playlistName: 'æ’­æ”¾åˆ—è¡¨åç§°',
    playlistNamePlaceholder: 'æˆ‘çš„æ’­æ”¾åˆ—è¡¨', importBtn: 'å¯¼å…¥', cancel: 'å–æ¶ˆ',
    addChannelTitle: 'æ·»åŠ é¢‘é“', channelName: 'é¢‘é“åç§°', group: 'åˆ†ç»„',
    logoURL: 'Logo åœ°å€ï¼ˆå¯é€‰ï¼‰', playlist: 'æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨', newPlaylist: 'æ–°å»ºæ’­æ”¾åˆ—è¡¨...',
    add: 'æ·»åŠ ', search: 'æœç´¢é¢‘é“...', noChannels: 'æš‚æ— é¢‘é“', noHistory: 'æš‚æ— å†å²è®°å½•',
    imported: 'å·²å¯¼å…¥', channels: 'ä¸ªé¢‘é“', deletePlaylist: 'åˆ é™¤æ’­æ”¾åˆ—è¡¨',
    confirmDelete: 'ç¡®è®¤åˆ é™¤æ­¤æ’­æ”¾åˆ—è¡¨ï¼Ÿ', loadError: 'åŠ è½½å¤±è´¥', playing: 'æ­£åœ¨æ’­æ”¾',
    fetchingM3U: 'æ­£åœ¨è·å– M3U...', parseError: 'M3U è§£æå¤±è´¥', networkError: 'ç½‘ç»œé”™è¯¯',
    urlRequired: 'è¯·è¾“å…¥è§†é¢‘åœ°å€', channelUrlRequired: 'è¯·å¡«å†™é¢‘é“åœ°å€',
    historyCleared: 'å†å²è®°å½•å·²æ¸…ç©º', parsePreview: 'è§£æåˆ°',
  },
  en: {
    play: 'Play', importM3U: 'Import M3U', playlists: 'Playlists', history: 'History',
    addChannel: 'Add', clearHistory: 'Clear', ready: 'Ready',
    noVideoTitle: 'Ready to Play', noVideoSub: 'Enter a URL above or pick a channel from the list',
    importM3UTitle: 'Import M3U Playlist', fromFile: 'From File', pasteText: 'Paste Text', fromURL: 'From URL',
    dropM3U: 'Drop .m3u / .m3u8 file here or click to browse', m3uHint: 'Supports standard M3U format with #EXTINF tags',
    pasteM3ULabel: 'Paste M3U content', m3uURL: 'M3U URL', playlistName: 'Playlist Name',
    playlistNamePlaceholder: 'My Playlist', importBtn: 'Import', cancel: 'Cancel',
    addChannelTitle: 'Add Channel', channelName: 'Channel Name', group: 'Group',
    logoURL: 'Logo URL (optional)', playlist: 'Add to Playlist', newPlaylist: 'New playlist...',
    add: 'Add', search: 'Search channels...', noChannels: 'No channels yet', noHistory: 'No history yet',
    imported: 'Imported', channels: ' channels', deletePlaylist: 'Delete Playlist',
    confirmDelete: 'Delete this playlist?', loadError: 'Load failed', playing: 'Now Playing',
    fetchingM3U: 'Fetching M3U...', parseError: 'M3U parse error', networkError: 'Network error',
    urlRequired: 'Please enter a URL', channelUrlRequired: 'Channel URL is required',
    historyCleared: 'History cleared', parsePreview: 'Parsed',
  }
};

let lang = localStorage.getItem('vp-lang') || 'zh';

function t(k) { return LANGS[lang][k] || k; }

function applyLang() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    if (k) el.textContent = t(k);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const k = el.getAttribute('data-i18n-placeholder');
    if (k) el.placeholder = t(k);
  });
  document.getElementById('lang-btn').textContent = lang === 'zh' ? 'EN' : 'ä¸­æ–‡';
  document.getElementById('channel-search').placeholder = t('search');
}

function toggleLang() {
  lang = lang === 'zh' ? 'en' : 'zh';
  localStorage.setItem('vp-lang', lang);
  applyLang();
  renderPlaylists();
  renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let store = { playlists: [], history: [] };
let currentChannel = null;
let hls = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const api = {
  async get(path) { const r = await fetch(path); return r.json(); },
  async post(path, body) { const r = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }); return r.json(); },
  async del(path) { const r = await fetch(path, { method:'DELETE' }); return r.json(); },
};

async function loadData() {
  try {
    store = await api.get('/api/data');
    if (!store.playlists) store.playlists = [];
    if (!store.history) store.history = [];
    renderPlaylists();
    renderHistory();
  } catch(e) { console.error(e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getLogoChar(name) {
  return (name || '?').trim().charAt(0).toUpperCase();
}

function getVideoType(url) {
  if (!url) return '';
  const u = url.toLowerCase().split('?')[0];
  if (u.endsWith('.m3u8') || u.includes('m3u8')) return 'hls';
  if (u.endsWith('.mp4') || u.endsWith('.webm') || u.endsWith('.mkv') || u.endsWith('.avi')) return 'mp4';
  if (u.startsWith('rtmp://')) return 'rtmp';
  return '';
}

function badgeHTML(url) {
  const t = getVideoType(url);
  if (!t) return '';
  return `<span class="badge badge-${t === 'hls' ? 'hls' : t === 'mp4' ? 'mp4' : 'rtmp'}">${t.toUpperCase()}</span>`;
}

function renderPlaylists() {
  const el = document.getElementById('playlist-channels');
  const q = (document.getElementById('channel-search').value || '').toLowerCase();
  
  if (!store.playlists.length) {
    el.innerHTML = `<div class="empty-state">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
      <p>${t('noChannels')}</p>
    </div>`;
    return;
  }

  let html = '';
  store.playlists.forEach(pl => {
    const filtered = pl.channels.filter(ch =>
      !q || ch.name.toLowerCase().includes(q) || (ch.group||'').toLowerCase().includes(q)
    );
    if (!filtered.length && q) return;

    html += `<div style="margin-bottom:4px;">
      <div class="playlist-header">
        <span style="font-size:14px;">ğŸ“‹</span>
        <span class="playlist-header-name">${esc(pl.name)}</span>
        <span class="playlist-count">${pl.channels.length}</span>
        <button class="icon-btn del" title="${t('deletePlaylist')}" onclick="deletePlaylist('${pl.id}',event)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6M10 11v6M14 11v6"/></svg>
        </button>
      </div>`;
    
    // group channels
    const grouped = {};
    filtered.forEach(ch => {
      const g = ch.group || '';
      if (!grouped[g]) grouped[g] = [];
      grouped[g].push(ch);
    });

    Object.entries(grouped).forEach(([group, chs]) => {
      if (group) html += `<div class="group-label">${esc(group)}</div>`;
      chs.forEach(ch => {
        const playing = currentChannel && currentChannel.url === ch.url;
        html += channelItemHTML(ch, playing);
      });
    });

    html += `</div>`;
  });

  el.innerHTML = html || `<div class="empty-state"><p>${t('noChannels')}</p></div>`;
}

function renderHistory() {
  const el = document.getElementById('history-list');
  if (!store.history || !store.history.length) {
    el.innerHTML = `<div class="empty-state">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <p>${t('noHistory')}</p>
    </div>`;
    return;
  }
  el.innerHTML = store.history.map(ch => {
    const playing = currentChannel && currentChannel.url === ch.url;
    return channelItemHTML(ch, playing, true);
  }).join('');
}

function channelItemHTML(ch, playing, isHistory=false) {
  const logoContent = ch.logo
    ? `<img src="${esc(ch.logo)}" onerror="this.style.display='none';this.nextSibling.style.display='flex'" alt=""><span style="display:none;width:100%;height:100%;align-items:center;justify-content:center;">${getLogoChar(ch.name)}</span>`
    : getLogoChar(ch.name);

  return `<div class="channel-item ${playing ? 'playing' : ''}" onclick="playChannel(${JSON.stringify(ch).replace(/"/g,'&quot;')})">
    <div class="channel-logo">${logoContent}</div>
    <div class="channel-info">
      <div class="channel-name">${esc(ch.name || ch.url)}</div>
      <div class="channel-group">${ch.group ? esc(ch.group) + ' Â· ' : ''}${badgeHTML(ch.url)}</div>
    </div>
    ${playing ? `<div class="playing-bars"><span></span><span></span><span></span></div>` : ''}
    <div class="channel-actions">
      <button class="icon-btn" title="Copy URL" onclick="copyURL('${esc(ch.url)}', event)">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
      </button>
    </div>
  </div>`;
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Player
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const video = document.getElementById('video');

function playChannel(ch) {
  currentChannel = ch;
  playURL(ch.url, ch.name || ch.url);
  // add to history
  api.post('/api/history', ch).then(() => {
    loadData();
  });
}

function playFromURLBar() {
  const url = document.getElementById('url-input').value.trim();
  if (!url) { toast(t('urlRequired'), 'error'); return; }
  playURL(url, url);
  const ch = { id: Date.now().toString(), name: url, url, group: '', logo: '', addedAt: Date.now() };
  currentChannel = ch;
  api.post('/api/history', ch).then(() => loadData());
}

function playURL(url, title) {
  // show player
  document.getElementById('no-video').style.display = 'none';
  document.getElementById('video-container').style.display = 'block';
  document.getElementById('overlay-title').textContent = title;
  document.getElementById('np-title').textContent = title;
  document.getElementById('np-url').textContent = url;
  document.getElementById('now-playing-info').style.display = 'block';
  document.getElementById('status-url').textContent = url;

  setStatus('loading', t('playing') + ': ' + (title.length > 50 ? title.slice(0,50)+'...' : title));
  showLoading(true);

  // Destroy old HLS
  if (hls) { hls.destroy(); hls = null; }

  const type = getVideoType(url);

  if (type === 'hls' || (!type && url.includes('m3u8'))) {
    // HLS
    if (Hls.isSupported()) {
      hls = new Hls({ enableWorker: false, lowLatencyMode: true });
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play().catch(()=>{});
        showLoading(false);
        setStatus('live', t('playing') + ': ' + title);
      });
      hls.on(Hls.Events.ERROR, (e, data) => {
        if (data.fatal) {
          showLoading(false);
          setStatus('error', t('loadError') + ': ' + (data.details || ''));
          toast(t('loadError'), 'error');
        }
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      // Safari native HLS
      video.src = url;
      video.play().catch(()=>{});
      showLoading(false);
      setStatus('live', t('playing') + ': ' + title);
    }
  } else {
    // Native video
    video.src = url;
    video.play().catch(()=>{});
    showLoading(false);
    setStatus('live', t('playing') + ': ' + title);
  }

  renderPlaylists();
  renderHistory();
}

video.addEventListener('error', () => {
  showLoading(false);
  setStatus('error', t('loadError'));
  toast(t('loadError'), 'error');
});

video.addEventListener('waiting', () => showLoading(true));
video.addEventListener('playing', () => showLoading(false));
video.addEventListener('timeupdate', updateProgress);
video.addEventListener('play', updatePlayBtn);
video.addEventListener('pause', () => {
  updatePlayBtn();
  document.getElementById('video-container').classList.add('paused');
});

function showLoading(v) {
  document.getElementById('loading-overlay').classList.toggle('active', v);
}

function setStatus(state, text) {
  const dot = document.getElementById('status-dot');
  dot.className = 'status-dot' + (state === 'live' ? ' live' : state === 'error' ? ' error' : '');
  document.getElementById('status-text').textContent = text;
}

function togglePlayPause() {
  if (video.paused) video.play(); else video.pause();
}

function updatePlayBtn() {
  document.getElementById('play-icon').style.display = video.paused ? 'block' : 'none';
  document.getElementById('pause-icon').style.display = video.paused ? 'none' : 'block';
  document.getElementById('video-container').classList.toggle('paused', video.paused);
}

function skip(s) {
  video.currentTime = Math.max(0, video.currentTime + s);
}

function seekTo(e) {
  const bar = document.getElementById('progress-bar');
  const rect = bar.getBoundingClientRect();
  const ratio = (e.clientX - rect.left) / rect.width;
  if (video.duration && isFinite(video.duration)) {
    video.currentTime = ratio * video.duration;
  }
}

function updateProgress() {
  const dur = video.duration;
  const cur = video.currentTime;
  if (dur && isFinite(dur)) {
    document.getElementById('progress-fill').style.width = (cur/dur*100) + '%';
    document.getElementById('time-label').textContent = fmtTime(cur) + ' / ' + fmtTime(dur);
  } else {
    document.getElementById('time-label').textContent = fmtTime(cur) + ' / âˆ';
  }
}

function fmtTime(s) {
  if (!s || isNaN(s)) return '0:00';
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = Math.floor(s%60);
  if (h) return `${h}:${pad(m)}:${pad(sec)}`;
  return `${m}:${pad(sec)}`;
}
function pad(n) { return String(n).padStart(2,'0'); }

function setVolume(v) { video.volume = v; }
function toggleMute() { video.muted = !video.muted; }
function toggleFullscreen() {
  const el = document.getElementById('video-container');
  if (!document.fullscreenElement) el.requestFullscreen().catch(()=>{});
  else document.exitFullscreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sidebar tabs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.sidebar-pane').forEach(p => p.classList.toggle('active', p.id === 'pane-' + tab));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Modals
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-backdrop').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// â”€â”€ Import Modal â”€â”€
function openImportModal() {
  openModal('modal-import');
  switchImportTab('file');
  document.getElementById('playlist-name-input').value = '';
  document.getElementById('import-preview').style.display = 'none';
  document.getElementById('m3u-text-input').value = '';
  document.getElementById('m3u-url-input').value = '';
}

let importTab = 'file';
function switchImportTab(tab) {
  importTab = tab;
  ['file','text','url'].forEach(t => {
    document.getElementById('import-' + t).style.display = t === tab ? 'block' : 'none';
    const btn = document.getElementById('itab-' + t);
    btn.className = 'btn btn-sm ' + (t === tab ? 'btn-primary' : 'btn-secondary');
  });
}

// Drag & Drop
function onDragOver(e) { e.preventDefault(); document.getElementById('drop-zone').classList.add('dragover'); }
function onDragLeave() { document.getElementById('drop-zone').classList.remove('dragover'); }
function onDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
}
function onFileSelect(e) { const file = e.target.files[0]; if (file) processFile(file); }

function processFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const content = e.target.result;
    showM3UPreview(content);
    document.getElementById('m3u-text-input').value = content;
    switchImportTab('text');
    if (!document.getElementById('playlist-name-input').value) {
      document.getElementById('playlist-name-input').value = file.name.replace(/\.(m3u8?|txt)$/i,'');
    }
  };
  reader.readAsText(file, 'utf-8');
}

function showM3UPreview(content) {
  const channels = parseM3U(content);
  const prev = document.getElementById('import-preview');
  prev.style.display = 'block';
  prev.textContent = `${t('parsePreview')} ${channels.length} ${t('channels')}`;
}

async function doImport() {
  let content = '';
  const name = document.getElementById('playlist-name-input').value.trim() || t('playlistNamePlaceholder');

  if (importTab === 'file' || importTab === 'text') {
    content = document.getElementById('m3u-text-input').value.trim();
  } else {
    const url = document.getElementById('m3u-url-input').value.trim();
    if (!url) { toast(t('urlRequired'), 'error'); return; }
    toast(t('fetchingM3U'), 'info');
    try {
      const r = await fetch(url);
      content = await r.text();
    } catch(e) {
      toast(t('networkError'), 'error'); return;
    }
  }

  if (!content) { toast(t('parseError'), 'error'); return; }

  const channels = parseM3U(content);
  if (!channels.length) { toast(t('parseError'), 'error'); return; }

  const playlist = {
    id: Date.now().toString(),
    name,
    channels,
    createdAt: Math.floor(Date.now()/1000)
  };

  await api.post('/api/playlists', playlist);
  await loadData();
  closeModal('modal-import');
  toast(`${t('imported')} ${channels.length} ${t('channels')}`, 'success');
}

// â”€â”€ M3U Parser â”€â”€
function parseM3U(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  const channels = [];
  let current = {};

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.startsWith('#EXTINF:')) {
      current = {};
      // Parse duration and attributes
      const attrStr = line.slice(8);
      // name is after the last comma
      const lastComma = attrStr.lastIndexOf(',');
      if (lastComma !== -1) current.name = attrStr.slice(lastComma + 1).trim();
      // extract tvg-* attributes
      const tvgName = attrStr.match(/tvg-name="([^"]*)"/i);
      const tvgLogo = attrStr.match(/tvg-logo="([^"]*)"/i);
      const groupTitle = attrStr.match(/group-title="([^"]*)"/i);
      if (tvgName) current.name = tvgName[1];
      if (tvgLogo) current.logo = tvgLogo[1];
      if (groupTitle) current.group = groupTitle[1];
    } else if (line.startsWith('#')) {
      // skip other comments
    } else if (line.startsWith('http') || line.startsWith('rtmp') || line.startsWith('rtp') || line.startsWith('udp')) {
      current.url = line;
      current.id = Date.now().toString() + Math.random().toString(36).slice(2);
      current.addedAt = Math.floor(Date.now()/1000);
      if (!current.name) current.name = line;
      channels.push({ ...current });
      current = {};
    }
  }
  return channels;
}

// â”€â”€ Add Channel Modal â”€â”€
function openAddChannelModal() {
  openModal('modal-add-channel');
  // populate playlist selector
  const sel = document.getElementById('ch-playlist');
  sel.innerHTML = `<option value="__new__">${t('newPlaylist')}</option>`;
  store.playlists.forEach(pl => {
    const opt = document.createElement('option');
    opt.value = pl.id; opt.textContent = pl.name;
    sel.appendChild(opt);
  });
  document.getElementById('ch-new-playlist-wrap').style.display = 'block';
  sel.onchange = () => {
    document.getElementById('ch-new-playlist-wrap').style.display = sel.value === '__new__' ? 'block' : 'none';
  };
}

async function doAddChannel() {
  const url = document.getElementById('ch-url').value.trim();
  if (!url) { toast(t('channelUrlRequired'), 'error'); return; }
  const name = document.getElementById('ch-name').value.trim() || url;
  const group = document.getElementById('ch-group').value.trim();
  const logo = document.getElementById('ch-logo').value.trim();

  const ch = { id: Date.now().toString(), name, url, group, logo, addedAt: Math.floor(Date.now()/1000) };

  const selVal = document.getElementById('ch-playlist').value;
  let playlist;

  if (selVal === '__new__') {
    const plName = document.getElementById('ch-new-playlist').value.trim() || t('playlistNamePlaceholder');
    playlist = { id: Date.now().toString(), name: plName, channels: [ch], createdAt: Math.floor(Date.now()/1000) };
  } else {
    playlist = store.playlists.find(p => p.id === selVal);
    if (!playlist) return;
    playlist = { ...playlist, channels: [...playlist.channels, ch] };
  }

  await api.post('/api/playlists', playlist);
  await loadData();
  closeModal('modal-add-channel');
  toast(`${name} ${t('imported') === 'å·²å¯¼å…¥' ? 'å·²æ·»åŠ ' : 'added'}`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Actions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function deletePlaylist(id, e) {
  e.stopPropagation();
  if (!confirm(t('confirmDelete'))) return;
  await api.del('/api/playlists/' + id);
  await loadData();
}

async function clearHistory() {
  await api.del('/api/history');
  await loadData();
  toast(t('historyCleared'), 'info');
}

function copyURL(url, e) {
  e.stopPropagation();
  navigator.clipboard.writeText(url).then(() => toast('URL copied', 'success')).catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Toast
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
  el.innerHTML = `<span>${icons[type]||''}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Keyboard shortcuts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
  if (e.key === ' ') { e.preventDefault(); togglePlayPause(); }
  if (e.key === 'ArrowLeft') skip(-5);
  if (e.key === 'ArrowRight') skip(5);
  if (e.key === 'ArrowUp') { video.volume = Math.min(1, video.volume+0.1); document.getElementById('vol-slider').value = video.volume; }
  if (e.key === 'ArrowDown') { video.volume = Math.max(0, video.volume-0.1); document.getElementById('vol-slider').value = video.volume; }
  if (e.key === 'f' || e.key === 'F') toggleFullscreen();
  if (e.key === 'm' || e.key === 'M') toggleMute();
});

// Enter key on URL bar
document.getElementById('url-input').addEventListener('keydown', e => { if (e.key === 'Enter') playFromURLBar(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
applyLang();
loadData();
</script>
</body>
</html>
