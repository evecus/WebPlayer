name: Build & Release

on:
  push:
    tags:
      - 'v*'             # 推送 v* tag   → 生成正式 Release
  workflow_dispatch:     # 支持在 Actions 页面手动点击触发

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build linux/amd64
        run: |
          GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w" \
            -o webplayer-linux-amd64 .

      - name: Build linux/arm64
        run: |
          GOOS=linux GOARCH=arm64 go build \
            -ldflags="-s -w" \
            -o webplayer-linux-arm64 .

      - name: Show file sizes
        run: |
          ls -lh webplayer-linux-*
          file webplayer-linux-*

      # ── 仅打 tag 时才发布到 Releases ──
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "WebPlayer ${{ github.ref_name }}"
          body: |
            ## WebPlayer ${{ github.ref_name }}

            ### 下载
            | 文件 | 架构 |
            |------|------|
            | `webplayer-linux-amd64` | x86_64 服务器/PC |
            | `webplayer-linux-arm64` | ARM64（树莓派、飞腾等） |

            ### 快速使用
            ```bash
            chmod +x webplayer-linux-amd64
            ./webplayer-linux-amd64
            # 然后访问 http://localhost:8888
            ```

            ### 参数
            ```
            -port  int     监听端口（默认 8888）
            -data  string  数据文件路径（默认 webplayer-data.json）
            ```
          files: |
            webplayer-linux-amd64
            webplayer-linux-arm64
          draft: false
          prerelease: false

      # ── 非 tag（main 分支）时，上传为 Artifact 供下载 ──
      - name: Upload Artifacts (dev build)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: webplayer-binaries
          path: |
            webplayer-linux-amd64
            webplayer-linux-arm64
          retention-days: 7
